// gcc rle_native.c -o rle_test

#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>

uint16_t rle_decompress(uint8_t *dest, uint16_t max, uint8_t *compressed,
                        uint8_t len, uint16_t bit_index) {
  uint16_t count = 0;
  uint8_t bit_offset = bit_index % 8;
  for (uint8_t d = 0; d < len; d++) {

    uint8_t bits = compressed[d];
    bool zeros = bits < 128;
    if (!zeros) {
      bits -= 128;
      printf("1:%d, ", bits);
    } else {
      printf("0:%d, ", bits);
    }
    for (uint8_t b = 0; b < bits; b++) {
      if (count / 8 >= max) {
        return count;
      }
      if (zeros) {
        *dest &= ~(1 << (7 - bit_offset));
      } else {
        *dest |= (1 << (7 - bit_offset));
      }
      count++;
      bit_offset++;
      if (bit_offset == 8) {
        printf("-> 0x%02x (%d->)", *dest, bits - b - 1);
        dest++;
        bit_offset = 0;
      }
    }
  }
  return count;
}

int main() {
  uint8_t original[] = {
      0x85, 0x9a, 0x27, 0xcb, 0xd7, 0xa3, 0xae, 0xfd, 0x2c, 0xcc, 0x45, 0x49,
      0xe1, 0xb3, 0x8a, 0xc3, 0x11, 0xf8, 0xac, 0x1c, 0xf0, 0xbf, 0xcd, 0xcf,
      0x89, 0x4b, 0xae, 0xfa, 0x71, 0x78, 0xcd, 0x55, 0x48, 0x9c, 0xf1, 0x2a,
      0x67, 0x4e, 0x72, 0x59, 0x3a, 0x8f, 0x8a, 0x1a, 0x05, 0x62, 0xac, 0x98,
      0xc7, 0x86, 0x5a, 0x8c, 0xbd, 0xa2, 0x0b, 0xe5, 0xa1, 0xd1, 0x98, 0xbb};
  uint8_t test_result[sizeof(original)];
  uint8_t compressed[] = {
      0x00, 0x81, 0x04, 0x81, 0x01, 0x82, 0x02, 0x82, 0x01, 0x81, 0x03, 0x81,
      0x02, 0x85, 0x02, 0x81, 0x01, 0x84, 0x01, 0x81, 0x01, 0x84, 0x01, 0x81,
      0x03, 0x83, 0x01, 0x81, 0x01, 0x83, 0x01, 0x86, 0x01, 0x81, 0x02, 0x81,
      0x01, 0x82, 0x02, 0x82, 0x02, 0x82, 0x03, 0x81, 0x03, 0x81, 0x01, 0x81,
      0x01, 0x81, 0x02, 0x81, 0x02, 0x84, 0x04, 0x82, 0x01, 0x82, 0x02, 0x83,
      0x03, 0x81, 0x01, 0x81, 0x01, 0x82, 0x04, 0x82, 0x03, 0x81, 0x03, 0x86,
      0x03, 0x81, 0x01, 0x81, 0x01, 0x82, 0x05, 0x83, 0x02, 0x84, 0x04, 0x81,
      0x01, 0x88, 0x02, 0x82, 0x01, 0x83, 0x02, 0x85, 0x03, 0x81, 0x02, 0x81,
      0x01, 0x81, 0x02, 0x81, 0x01, 0x83, 0x01, 0x81, 0x01, 0x83, 0x01, 0x85,
      0x01, 0x81, 0x02, 0x83, 0x03, 0x81, 0x01, 0x84, 0x03, 0x82, 0x02, 0x82,
      0x01, 0x81, 0x01, 0x81, 0x01, 0x81, 0x01, 0x81, 0x01, 0x81, 0x01, 0x81,
      0x02, 0x81, 0x03, 0x81, 0x02, 0x83, 0x02, 0x84, 0x03, 0x81, 0x02, 0x81,
      0x01, 0x81, 0x01, 0x81, 0x02, 0x82, 0x02, 0x83, 0x01, 0x81, 0x02, 0x83,
      0x02, 0x83, 0x02, 0x81, 0x02, 0x81, 0x01, 0x82, 0x02, 0x81, 0x02, 0x83,
      0x01, 0x81, 0x01, 0x81, 0x03, 0x85, 0x03, 0x81, 0x01, 0x81, 0x04, 0x82,
      0x01, 0x81, 0x06, 0x81, 0x01, 0x81, 0x01, 0x82, 0x03, 0x81, 0x01, 0x81,
      0x01, 0x81, 0x01, 0x82, 0x02, 0x81, 0x02, 0x82, 0x03, 0x82, 0x03, 0x84,
      0x04, 0x82, 0x02, 0x81, 0x01, 0x82, 0x01, 0x81, 0x01, 0x81, 0x03, 0x82,
      0x02, 0x81, 0x01, 0x84, 0x01, 0x82, 0x01, 0x81, 0x03, 0x81, 0x05, 0x81,
      0x01, 0x85, 0x02, 0x81, 0x01, 0x82, 0x01, 0x81, 0x04, 0x83, 0x01, 0x81,
      0x03, 0x82, 0x02, 0x82, 0x03, 0x81, 0x01, 0x83, 0x01, 0x82};
  uint16_t num_bits = rle_decompress(test_result, sizeof(test_result),
                                     compressed, sizeof(compressed), 0);

  printf("Original (%ld):\n", sizeof(original));
  for (uint16_t idx = 0; idx < sizeof(original); idx++) {
    printf("0x%02x,", original[idx]);
  }

  printf("\nDecompressed (%d, %d bits):\n", num_bits / 8, num_bits);
  for (uint16_t idx = 0; idx < sizeof(test_result); idx++) {
    printf("0x%02x,", test_result[idx]);
  }
  printf("\nDone.\n");
  return 0;
}
// gcc rle_native.c -o rle_test

#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

uint16_t rle_decompress(uint8_t *dest, uint16_t max, uint8_t *compressed,
                        uint8_t len, uint16_t bit_index) {
  uint16_t count = 0;
  uint8_t bit_offset = bit_index % 8;
  for (uint8_t d = 0; d < len; d++) {

    uint8_t bits = compressed[d];
    bool zeros = bits < 128;
    if (!zeros) {
      bits -= 128;
      printf("1:%d, ", bits);
    } else {
      printf("0:%d, ", bits);
    }
    for (uint8_t b = 0; b < bits; b++) {
      if (count / 8 >= max) {
        return count;
      }
      if (zeros) {
        *dest &= ~(1 << (7 - bit_offset));
      } else {
        *dest |= (1 << (7 - bit_offset));
      }
      count++;
      bit_offset++;
      if (bit_offset == 8) {
        printf("-> 0x%02x (%d->)", *dest, bits - b - 1);
        dest++;
        bit_offset = 0;
      }
    }
  }
  return count;
}

void rle_test() {
  uint8_t original[] = {
      0x85, 0x9a, 0x27, 0xcb, 0xd7, 0xa3, 0xae, 0xfd, 0x2c, 0xcc, 0x45, 0x49,
      0xe1, 0xb3, 0x8a, 0xc3, 0x11, 0xf8, 0xac, 0x1c, 0xf0, 0xbf, 0xcd, 0xcf,
      0x89, 0x4b, 0xae, 0xfa, 0x71, 0x78, 0xcd, 0x55, 0x48, 0x9c, 0xf1, 0x2a,
      0x67, 0x4e, 0x72, 0x59, 0x3a, 0x8f, 0x8a, 0x1a, 0x05, 0x62, 0xac, 0x98,
      0xc7, 0x86, 0x5a, 0x8c, 0xbd, 0xa2, 0x0b, 0xe5, 0xa1, 0xd1, 0x98, 0xbb};
  uint8_t test_result[sizeof(original)];
  uint8_t compressed[] = {
      0x00, 0x81, 0x04, 0x81, 0x01, 0x82, 0x02, 0x82, 0x01, 0x81, 0x03, 0x81,
      0x02, 0x85, 0x02, 0x81, 0x01, 0x84, 0x01, 0x81, 0x01, 0x84, 0x01, 0x81,
      0x03, 0x83, 0x01, 0x81, 0x01, 0x83, 0x01, 0x86, 0x01, 0x81, 0x02, 0x81,
      0x01, 0x82, 0x02, 0x82, 0x02, 0x82, 0x03, 0x81, 0x03, 0x81, 0x01, 0x81,
      0x01, 0x81, 0x02, 0x81, 0x02, 0x84, 0x04, 0x82, 0x01, 0x82, 0x02, 0x83,
      0x03, 0x81, 0x01, 0x81, 0x01, 0x82, 0x04, 0x82, 0x03, 0x81, 0x03, 0x86,
      0x03, 0x81, 0x01, 0x81, 0x01, 0x82, 0x05, 0x83, 0x02, 0x84, 0x04, 0x81,
      0x01, 0x88, 0x02, 0x82, 0x01, 0x83, 0x02, 0x85, 0x03, 0x81, 0x02, 0x81,
      0x01, 0x81, 0x02, 0x81, 0x01, 0x83, 0x01, 0x81, 0x01, 0x83, 0x01, 0x85,
      0x01, 0x81, 0x02, 0x83, 0x03, 0x81, 0x01, 0x84, 0x03, 0x82, 0x02, 0x82,
      0x01, 0x81, 0x01, 0x81, 0x01, 0x81, 0x01, 0x81, 0x01, 0x81, 0x01, 0x81,
      0x02, 0x81, 0x03, 0x81, 0x02, 0x83, 0x02, 0x84, 0x03, 0x81, 0x02, 0x81,
      0x01, 0x81, 0x01, 0x81, 0x02, 0x82, 0x02, 0x83, 0x01, 0x81, 0x02, 0x83,
      0x02, 0x83, 0x02, 0x81, 0x02, 0x81, 0x01, 0x82, 0x02, 0x81, 0x02, 0x83,
      0x01, 0x81, 0x01, 0x81, 0x03, 0x85, 0x03, 0x81, 0x01, 0x81, 0x04, 0x82,
      0x01, 0x81, 0x06, 0x81, 0x01, 0x81, 0x01, 0x82, 0x03, 0x81, 0x01, 0x81,
      0x01, 0x81, 0x01, 0x82, 0x02, 0x81, 0x02, 0x82, 0x03, 0x82, 0x03, 0x84,
      0x04, 0x82, 0x02, 0x81, 0x01, 0x82, 0x01, 0x81, 0x01, 0x81, 0x03, 0x82,
      0x02, 0x81, 0x01, 0x84, 0x01, 0x82, 0x01, 0x81, 0x03, 0x81, 0x05, 0x81,
      0x01, 0x85, 0x02, 0x81, 0x01, 0x82, 0x01, 0x81, 0x04, 0x83, 0x01, 0x81,
      0x03, 0x82, 0x02, 0x82, 0x03, 0x81, 0x01, 0x83, 0x01, 0x82};
  uint16_t num_bits = rle_decompress(test_result, sizeof(test_result),
                                     compressed, sizeof(compressed), 0);

  printf("Original (%ld):\n", sizeof(original));
  for (uint16_t idx = 0; idx < sizeof(original); idx++) {
    printf("0x%02x,", original[idx]);
  }

  printf("\nDecompressed (%d, %d bits):\n", num_bits / 8, num_bits);
  for (uint16_t idx = 0; idx < sizeof(test_result); idx++) {
    printf("0x%02x,", test_result[idx]);
  }
  printf("\nDone.\n");
}

#define SCREEN_WIDTH 72

// dest*
// |
// V
// +-----------SCREEN_WIDTH-------------+
// |                                    |
// |             +--------w---------+   |
// |             |(x,y)             |   |
// |             |                  |   |
// |             h   bit_index@@@@@@|   | (bit_index = last bit index that was copied + 1)
// |             |@@@@@@@@@@@@len   |   |
// |             |                  |   |
// |             +------------------+   |
// |                                    |
// +------------------------------------+
//
// +--------w---------+
// |(x,y)             |
// |                  |
// h   <-data*@@@@@@@@|
// |@@@@@@@@@@@@len   | (len in num of bits)
// |                  |
// +------------------+

uint16_t copy_rectangle_to_overlay(uint8_t *dest, uint8_t *data, uint8_t x,
                                   uint8_t y, uint8_t w, uint8_t h,
                                   uint16_t *bit_idx, uint16_t bitlen) {
  uint16_t bit_cnt = 0;
  uint8_t start_y = *bit_idx / SCREEN_WIDTH;
  uint8_t stop_y = y + h;
  for (uint8_t dest_y = start_y; dest_y < stop_y; dest_y++) {
    uint8_t start_x = bit_cnt == 0 ? *bit_idx % SCREEN_WIDTH : x;
    uint8_t stop_x = x + w;
    for (uint8_t dest_x = start_x; dest_x < stop_x; dest_x++) {
      *bit_idx = dest_y * SCREEN_WIDTH + dest_x;
      uint8_t data_byte = data[bit_cnt / 8];
      uint8_t bit_in_byte = bit_cnt % 8;
      bool bit_is_set = ((0x80 >> bit_in_byte) & data_byte) != 0;

      if (bit_is_set) {
        dest[(*bit_idx) / 8] |= 0x80 >> (*bit_idx % 8);
      } else {
        dest[(*bit_idx) / 8] &= ~(0x80 >> (*bit_idx % 8));
      }
      
      bit_cnt++;
      if (bit_cnt >= bitlen) {
        *bit_idx = *bit_idx + 1;
        return bit_cnt;
      }
    }
  }
  *bit_idx = *bit_idx + 1;
  return bit_cnt;
}

uint16_t min(uint16_t a, uint16_t b) {
  if (a < b) {
    return a;
  }
  return b;
}

void roi_test_0() {
  uint8_t all[] = {
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x1,  0x80, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x7,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0xf,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x3e, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0xfc, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0xfc, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x7,  0xf8, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0xf,  0xf0, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x1f, 0xe0, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1f, 0xc0, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x3f, 0x80, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x7f, 0x83, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x61, 0x6,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x80, 0xcc, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x7,  0x0,  0x48, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x12, 0x0,  0x78, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x4c,
      0x80, 0x30, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1d, 0x80, 0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x22, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x48, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x12, 0x0,  0x0,  0x0};
  uint8_t roi_y = 18, roi_x = 41, roi_yy = 38, roi_xx = 63;
  uint8_t roi[] = {0x0,  0x0,  0x2,  0x0,  0x0,  0x1c, 0x0,  0x0,  0x78,
                   0x0,  0x3,  0xe0, 0x0,  0x1f, 0x80, 0x0,  0x7f, 0x0,
                   0x3,  0xfc, 0x0,  0xf,  0xf0, 0x0,  0x3f, 0xc0, 0x0,
                   0x7f, 0x0,  0x1,  0xfc, 0x0,  0x7,  0xf8, 0x30, 0xc,
                   0x20, 0xc0, 0x20, 0x33, 0x3,  0x80, 0x24, 0x12, 0x0,
                   0x78, 0x99, 0x0,  0x60, 0x76, 0x0,  0x1,  0x10, 0x0,
                   0x4,  0x80, 0x0,  0x0,  0x0,  0x0,  0x0};
  uint8_t croi[] = {
      0x16, 0x81, 0x14, 0x83, 0x13, 0x84, 0x11, 0x85, 0x10, 0x86, 0x10, 0x87,
      0xe,  0x88, 0xe,  0x88, 0xe,  0x88, 0xf,  0x87, 0xf,  0x87, 0xf,  0x88,
      0x5,  0x82, 0x8,  0x82, 0x4,  0x81, 0x5,  0x82, 0x8,  0x81, 0x7,  0x82,
      0x2,  0x82, 0x6,  0x83, 0x9,  0x81, 0x2,  0x81, 0x5,  0x81, 0x2,  0x81,
      0xa,  0x84, 0x3,  0x81, 0x2,  0x82, 0x2,  0x81, 0x9,  0x82, 0x6,  0x83,
      0x1,  0x82, 0x10, 0x81, 0x3,  0x81, 0x11, 0x81, 0x2,  0x81, 0x2f};

  uint8_t dest[360];
  memset(&dest, 0, sizeof(dest));

  uint16_t copied_bits = 0;
  uint16_t hid_bit_index = roi_y * SCREEN_WIDTH + roi_x;
  for (int i = 0; i < sizeof(roi) / 26 + 1; i++) {
    uint16_t bit_len = min(26 * 8, sizeof(roi) * 8 - copied_bits);
   // printf("Processing data chunk %d / %d\n", i, bit_len / 8);
    uint16_t copied = copy_rectangle_to_overlay(
        dest, &roi[i * 26], roi_x, roi_y, roi_xx - roi_x, roi_yy - roi_y,
        &hid_bit_index, bit_len);
    copied_bits += copied;
    // printf("Processed %d bits (%d bytes) %d hid_bit_index \n", copied,
    //        copied / 8, hid_bit_index);
  }
  printf("Processed %u bits\n", copied_bits);
  for (int i = 0; i < sizeof(dest); i++) {
    if (dest[i] != all[i]) {
      // printf("Does not match dest[%d] 0x%02x!=0x%02x\n", i, dest[i], all[i]);
      // return;
      printf("%d-%02x-%02x, ", i, dest[i], all[i]);
    } 
    // else {
    //   printf("0x%02x, ", dest[i]);
    // }
  }
  printf("All equal!");
}

void roi_test_1() {
  uint8_t all[] = {
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x38, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xff, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xff, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xe1, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xc0, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0xe0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1f, 0xe0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3f, 0xf0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xfe, 0x18, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xff, 0xff, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
    };
    uint8_t roi_y = 15, roi_x = 45, roi_yy = 37, roi_xx = 69;
    uint8_t roi[] = {
    0x0, 0x7, 0x0, 0x0, 0x1f, 0xe0, 0x0, 0x3f, 0xf0, 0x0, 0x7f, 0xf0, 0x0, 0x7c, 0x38, 0x0, 0x78, 0x18, 0x0, 0xf8, 0x0, 0x0, 0xf8, 0x0, 0x1, 0xf8, 0x0, 0x1, 0xfc, 0x0, 0x3, 0xfc, 0x0, 0x7, 0xfe, 0x0, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
    };
    uint8_t croi[] = {
    0xd, 0x83, 0x13, 0x88, 0xf, 0x8a, 0xd, 0x8b, 0xd, 0x85, 0x4, 0x83, 0xc, 0x84, 0x6, 0x82, 0xb, 0x85, 0x13, 0x85, 0x12, 0x86, 0x12, 0x87, 0x10, 0x88, 0xf, 0x8a, 0x9, 0x92, 0x4, 0xff, 0xdb
    };
  uint8_t dest[360];
  memset(&dest, 0, sizeof(dest));

  uint16_t copied_bits = 0;
  uint16_t hid_bit_index = roi_y * SCREEN_WIDTH + roi_x;
  for (int i = 0; i < sizeof(roi) / 26 + 1; i++) {
    uint16_t bit_len = min(26 * 8, sizeof(roi) * 8 - copied_bits);
    //printf("Processing data chunk %d / %d\n", i, bit_len / 8);
    uint16_t copied = copy_rectangle_to_overlay(
        dest, &roi[i * 26], roi_x, roi_y, roi_xx - roi_x, roi_yy - roi_y,
        &hid_bit_index, bit_len);
    copied_bits += copied;
    //       copied / 8, hid_bit_index);
  }
  //printf("Processed %u bits\n", copied_bits);
  for (int i = 0; i < sizeof(dest); i++) {
    if (dest[i] != all[i]) {
      // printf("Does not match dest[%d] 0x%02x!=0x%02x\n", i, dest[i], all[i]);
      // return;
      printf("%d-%02x-%02x, ", i, dest[i], all[i]);
    } 
    // else {
    //   printf("0x%02x, ", dest[i]);
    // }
  }
  printf("All equal!");
}

void roi_test_5() {
  uint8_t all[] = {
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1f, 0xf0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3f, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x78, 0x3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf0, 0xe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0xe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0x6, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0xe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x78, 0x1e, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3f, 0xfe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1f, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xe3, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x70, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x38, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x10, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
    };
    uint8_t roi_y = 0, roi_x = 0, roi_yy = 40, roi_xx = 72;
    uint8_t roi[] = {
      0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1f, 0xf0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3f, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x78, 0x3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf0, 0xe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0xe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0x6, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0xe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x78, 0x1e, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3f, 0xfe, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1f, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xe3, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x70, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x38, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x10, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
      };
    uint8_t croi[] = {
    0x7, 0x84, 0xf, 0x89, 0xc, 0x8b, 0xa, 0x84, 0x5, 0x84, 0x8, 0x84, 0x8, 0x83, 0x7, 0x83, 0x9, 0x83, 0x7, 0x82, 0xb, 0x83, 0x5, 0x83, 0xb, 0x83, 0x5, 0x83, 0xb, 0x83, 0x5, 0x83, 0xb, 0x83, 0x5, 0x83, 0xb, 0x83, 0x6, 0x83, 0xa, 0x82, 0x7, 0x83, 0x9, 0x83, 0x8, 0x84, 0x6, 0x84, 0x9, 0x8d, 0xa, 0x8d, 0xb, 0x86, 0x3, 0x83, 0x14, 0x83, 0x14, 0x83, 0x14, 0x83, 0x14, 0x83, 0x14, 0x81, 0x5
    };
  uint8_t dest[360];
  memset(&dest, 0, sizeof(dest));

  uint16_t copied_bits = 0;
  uint16_t hid_bit_index = 0;//roi_y * SCREEN_WIDTH + roi_x;
  for (int i = 0; i < sizeof(roi) / 26 + 1; i++) {
    uint16_t bit_len = min(26 * 8, sizeof(roi) * 8 - copied_bits);
    printf("Processing data chunk %d / %d\n", i, bit_len / 8);
    uint16_t copied = copy_rectangle_to_overlay(
        dest, &roi[i * 26], roi_x, roi_y, roi_xx - roi_x, roi_yy - roi_y,
        &hid_bit_index, bit_len);
    copied_bits += copied;
    printf("Processed %d bits (%d bytes) %d hid_bit_index \n", copied,
           copied / 8, hid_bit_index);
  }
  printf("Processed %u bits\n", copied_bits);
  for (int i = 0; i < sizeof(dest); i++) {
    if (dest[i] != all[i]) {
      // printf("Does not match dest[%d] 0x%02x!=0x%02x\n", i, dest[i], all[i]);
      // return;
      printf("%d-%02x-%02x, ", i, dest[i], all[i]);
    } 
    // else {
    //   printf("0x%02x, ", dest[i]);
    // }
  }
  printf("All equal!");
}

void roi_test_2() {
  uint8_t all[] = {
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x30, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x78, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0xfc, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x1,  0xfe, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0xfe, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x78, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x78, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x78, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x30, 0x78, 0x30,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x70, 0x78, 0x38, 0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0xff, 0xff, 0xfc, 0x0,  0x0,  0x0,  0x0,  0x0,  0x1,
      0xff, 0xff, 0xfe, 0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0xff, 0xff, 0xfe,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0xff, 0xff, 0xfc, 0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x70, 0x78, 0x38, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x30, 0x78, 0x30, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x78, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x78, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x78, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x1,  0xfe, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x1,  0xfe, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0xfc, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x78, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x30, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0};
  uint8_t roi_x = 15, roi_y = 47, roi_xx = 38, roi_yy = 70;
  uint8_t roi[] = {0x0,  0x18, 0x0,  0x0,  0x78, 0x0,  0x1,  0xf8, 0x0,  0x7,
                   0xf8, 0x0,  0xf,  0xf0, 0x0,  0x7,  0x80, 0x0,  0xf,  0x0,
                   0x0,  0x1e, 0x0,  0x18, 0x3c, 0x18, 0x70, 0x78, 0x39, 0xff,
                   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xef, 0xff, 0xff,
                   0xce, 0xf,  0x7,  0xc,  0x1e, 0xc,  0x0,  0x3c, 0x0,  0x0,
                   0x78, 0x0,  0x0,  0xf0, 0x0,  0x7,  0xf8, 0x0,  0xf,  0xf0,
                   0x0,  0xf,  0xc0, 0x0,  0xf,  0x0,  0x0};
  uint8_t croi[] = {0xb,  0x82, 0x14, 0x84, 0x12, 0x86, 0x10, 0x88, 0xf,  0x88,
                    0x11, 0x84, 0x13, 0x84, 0x13, 0x84, 0xc,  0x82, 0x5,  0x84,
                    0x5,  0x82, 0x4,  0x83, 0x5,  0x84, 0x5,  0x83, 0x2,  0xc4,
                    0x1,  0x96, 0x2,  0x83, 0x5,  0x84, 0x5,  0x83, 0x4,  0x82,
                    0x5,  0x84, 0x5,  0x82, 0xc,  0x84, 0x13, 0x84, 0x13, 0x84,
                    0x11, 0x88, 0xf,  0x88, 0x10, 0x86, 0x12, 0x84, 0x10};
}
void roi_test_3() {
  uint8_t all[] = {
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0xe,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x1f,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x3f, 0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0xf,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0xc6, 0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x1,  0xe0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x3,  0xf0, 0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x7,  0xf0, 0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0xf,  0xe0, 0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x1f, 0xc0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x3f, 0x80, 0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x0,  0x7f, 0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x0,  0xfe, 0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x1,  0xfc, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x3, 0xf8, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x7,  0xf0, 0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x7,  0xe0, 0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0xf,  0xc0, 0x0,
      0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0xf, 0x80, 0x0,  0x0,  0x0,  0x0,
      0x0,  0x0,  0x0,  0x1f, 0x0,  0x0,  0x0, 0x0,  0x0,  0x0,  0x0,  0x0,
      0x1c, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,  0x0,  0x20, 0x0,  0x0};
  uint8_t roi_x = 18, roi_y = 50, roi_xx = 39, roi_yy = 71;
  uint8_t roi[] = {0x0,  0x0, 0x38, 0x0,  0x3, 0xc0, 0x0, 0x3e, 0x0,  0x0,
                   0x70, 0x0, 0x31, 0x80, 0x3, 0xc0, 0x0, 0x3f, 0x0,  0x3,
                   0xf8, 0x0, 0x3f, 0x80, 0x3, 0xf8, 0x0, 0x3f, 0x80, 0x3,
                   0xf8, 0x0, 0x3f, 0x80, 0x3, 0xf8, 0x0, 0x3f, 0x80, 0x3,
                   0xf8, 0x0, 0x1f, 0x80, 0x1, 0xf8, 0x0, 0xf,  0x80, 0x0,
                   0xf8, 0x0, 0x7,  0x0,  0x0, 0x0};
  uint8_t croi[] = {0x12, 0x83, 0x11, 0x84, 0x10, 0x85, 0x12, 0x83, 0xe,
                    0x82, 0x3,  0x82, 0xd,  0x84, 0x10, 0x86, 0xe,  0x87,
                    0xd,  0x87, 0xd,  0x87, 0xd,  0x87, 0xd,  0x87, 0xd,
                    0x87, 0xd,  0x87, 0xd,  0x87, 0xd,  0x87, 0xe,  0x86,
                    0xe,  0x86, 0xf,  0x85, 0xf,  0x85, 0x10, 0x83, 0x18};
}

void header_test_1() {
  uint8_t top = 9, left = 3, bottom = 37, right = 71, mods = 2;
  bool rle = true;
  uint8_t header[] = {0x22, 0x95, 0x3, 0xc7};

  uint8_t r_mods = header[0] & 0x0f;
  uint8_t r_y = (header[1] & 0x03) | ((header[0] >> 2) & 0x3c);
  uint8_t r_yy = header[1] >> 2;
  uint8_t r_x = header[2];
  uint8_t r_xx = header[3] & 0x7f;
  bool r_rle = ((header[3] & 0x80) != 0);
  if (top == r_y && left == r_x && bottom == r_yy && right == r_xx &&
    mods == r_mods && rle == r_rle) {
  printf("All header fields are equal!\n");
} else {
  printf("Problem in header fields detected!\n");
}
}


void header_test_2() {
  uint8_t top = 15, left = 56, bottom = 31, right = 69, mods = 5;
  bool rle = false;
  uint8_t header[] = {0x35, 0x7f, 0x38, 0x45};

  uint8_t r_mods = header[0] & 0x0f;
  uint8_t r_y = (header[1] & 0x03) | ((header[0] >> 2) & 0x3c);
  uint8_t r_yy = header[1] >> 2;
  uint8_t r_x = header[2];
  uint8_t r_xx = header[3] & 0x7f;
  bool r_rle = ((header[3] & 0x80) != 0);
  if (top == r_y && left == r_x && bottom == r_yy && right == r_xx &&
      mods == r_mods && rle == r_rle) {
    printf("All header fields are equal!\n");
  } else {
    printf("Problem in header fields detected!\n");
  }
}

int main() {
  rle_test();
  roi_test_1();
  //roi_test_2();
  //roi_test_3();

  //roi_test_5();
  header_test_1();
  header_test_2();
  return 0;
}
